# 项目搭建

记录搭建项目过程

## 1. 创建 vite 项目

```bash
pnpm create vite vue-admin --template vue-ts
```

## 2. 配置路径别名

1. 安装`@types/node`

```bash
  pnpm add @types/node -D
```

2. 修改`vite.config.ts`

```typescript
import { defineConfig } from 'vite';
import vue from '@vitejs/plugin-vue';
import path from 'node:path';

// https://vitejs.dev/config/
export default defineConfig({
  plugins: [vue()],
  resolve: {
    alias: {
      '@': path.resolve(__dirname, 'src'),
    },
  },
});
```

3. 修改`tsconfig.app.json`

```json
{
  "compilerOptions": {
    "baseUrl": "./",
    "paths": {
      "@/*": ["src/*"]
    }
  }
}
```

4. 新建 `src/types/custom-types.d.ts`

```ts
// 声明.vue文件
declare module '*.vue' {
  import { DefineComponent } from 'vue';
  const component: DefineComponent<object, object, any>;
  export default component;
}
```

## 3. 添加路由

1. 安装`vue-router`

```bash
pnpm add vue-router
```

2. 在`src`目录下新建`pages`和`router`文件夹
3. 在`pages`目录下新建页面组件`home/index.vue`，`about/index.vue`

```vue
// src/pages/home/index.vue
<template>
  <div>home page</div>
</template>
```

```vue
// src/pages/about/index.vue
<template>
  <div>about page</div>
</template>
```

4. 在`router`目录下创建`index.ts` 和 `routes.ts`

```ts
// src/router/routes.ts
const routes = [
  {
    path: '/home',
    component: () => import('@/pages/home.vue'),
  },
  {
    path: '/about',
    component: () => import('@/pages/about.vue'), //路由懒加载
  },
];

export default routes;
```

```ts
// src/router/index.ts
import { createRouter, createWebHistory } from 'vue-router';
import routes from './routes';

const router = createRouter({
  history: createWebHistory(), //可传参数，配置base路径，例如'/app'
  routes,
});

export default router;
```

5. 修改 `src/main.ts`

```ts
// src/main.ts
import { createApp } from 'vue';
import './style.css';
import App from './App.vue';
import router from './router/index';

const app = createApp(App);

app.use(router);
app.mount('#app');
```

6. 修改 App.vue

```vue
<script setup lang="ts"></script>

<template>
  <router-view v-slot="{ Component }">
    <Transition name="fade" mode="out-in">
      <component :is="Component" />
    </Transition>
  </router-view>
</template>

<style scoped>
.fade-enter-active,
.fade-leave-active {
  transition: all 0.2s ease;
}

.fade-enter-from,
.fade-leave-active {
  opacity: 0;
}
</style>
```

## 4. 添加 pinia

1. 安装`pinia`依赖

```bash
pnpm add pinia
```

2. 在`src`目录下新建`store`文件夹，添加`counter.ts`和`index.ts`

```ts
// src/store/index.ts
import { createPinia } from 'pinia';

const store = createPinia();
export default store;
```

```ts
// src/store/counter.ts
import { defineStore } from 'pinia';

// defineStore 第一个参数是id，必需且值唯一
export const useCounterStore = defineStore('counter', {
  // state返回一个函数，防止作用域污染
  state: () => {
    return {
      count: 1,
    };
  },
  actions: {
    increase() {
      this.count++;
    },
    decrease() {
      this.count--;
    },
  },
});
```

3. 在组件中使用，先在 `main.ts` 里引入,在`src/pages/home/index.vue`使用

`store` 是一个用 `reactive` 包装的对象，直接解构读取 `state` 会失去响应式，因此需要 `storeToRefs`，它将为每一个响应式属性创建引用；需通过 `.value` 读取解构出来的值

```ts
// main.ts
import { createApp } from 'vue';
import './style.css';
import App from './App.vue';
import router from './router/index';
import store from './store';

const app = createApp(App);

app.use(router);
app.use(store);
app.mount('#app');
```

```vue
<script lang="ts" setup>
import { storeToRefs } from 'pinia';
import { useCounterStore } from '@/store/counter';
const counterStore = useCounterStore();
// storeToRefs 会跳过所有的 action 属性
const { count } = storeToRefs(counterStore);
const { increase, decrease } = counterStore;
</script>
<template>
  <div>home page</div>
  <div>count: {{ count }}</div>
  <button @click="increase">+1</button>
  <button @click="decrease">-1</button>
</template>
```

## 5. 添加 ant-design-vue

1. 安装依赖`ant-design-vue`，`dayjs`，`unplugin-auto-import` ，`unplugin-vue-components`

```bash
pnpm add ant-design-vue
pnpm add dayjs
pnpm add unplugin-auto-import -D
pnpm add unplugin-vue-components -D
```

2. 修改`vite.config.ts`

```ts
import AutoImport from 'unplugin-auto-import/vite';
import Components from 'unplugin-vue-components/vite';
import { AntDesignVueResolver } from 'unplugin-vue-components/resolvers';
import { defineConfig } from 'vite';
defineConfig({
  plugins: [
    AutoImport({
      resolvers: [
        AntDesignVueResolver({
          resolveIcons: true,
          importStyle: 'css-in-js',
        }),
      ],
      dts: path.resolve(pwd, 'src/types', 'auto-imports.d.ts'), // 指定自动导入函数TS类型声明文件路径
    }),
    Components({
      resolvers: [
        AntDesignVueResolver({
          resolveIcons: true,
          importStyle: 'css-in-js',
        }),
      ],
      dts: path.resolve(pwd, 'src/types', 'components.d.ts'),
    }),
  ],
});
```

3. 在`src/pages/home/index.vue`里引入组件

```vue
<script lang="ts" setup>
import { storeToRefs } from 'pinia';
import { useCounterStore } from '@/store/counter';
const counterStore = useCounterStore();
// storeToRefs 会跳过所有的 action 属性
const { count } = storeToRefs(counterStore);
const { increase, decrease } = counterStore;
</script>
<template>
  <div>home page</div>
  <div>count: {{ count }}</div>
  <button @click="increase">+1</button>
  <button @click="decrease">-1</button>
  <a-button type="primary">主要按钮</a-button>
  <a-button>Default Button</a-button>
  <a-button type="dashed">Dashed Button</a-button>
  <a-button type="text">Text Button</a-button>
  <a-button type="link">Link Button</a-button>
</template>
```

## 6. 配置环境变量

新建 .env（所有环境生效）.env.development（开发环境配置） .env.production（生产环境配置）

1. 定义变量
   以 VITE\_ 为前缀定义变量

```ini
# .env
VITE_APP_TITLE = 'vue后台管理系统'
VITE_BASE_URL = '/vue'
VITE_BASE_API_PATH = '/api'
VITE_APP_PORT = 3002
```

```ini
# .env.development
VITE_BASE_API_ORIGIN = 'http://localhost:3000'
```

```ini
# .env.production
VITE_BASE_API_ORIGIN = 'http://localhost:3000'
```

2. 定义类型
   修改 vite-env.d.ts

```typescript
/// <reference types="vite/client" />
/// <reference types="vite/client" />

interface ImportMetaEnv {
  readonly VITE_BASE_URL: string;
  readonly VITE_APP_TITLE: string;
  readonly VITE_APP_PORT: string;
  readonly VITE_BASE_API_ORIGIN: string;
  readonly VITE_BASE_API_PATH: string;
}

interface ImportMeta {
  readonly env: ImportMetaEnv;
}
```

3. 使用变量
   替换`src/router/index.ts`中的`basename`，替换`index.html`中的`title`

```ts
import { createRouter, createWebHistory } from 'vue-router';
import routes from './routes';

const router = createRouter({
  history: createWebHistory(import.meta.env.VITE_BASE_URL), // 可传参数，配置base路径，例如'/app'
  routes,
});

export default router;
```

```html
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>%VITE_APP_TITLE%</title>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
```

4. 在`vite.config.ts`中使用环境变量
   修改默认导出为一个函数，使用`loadEnv`读取环境变量，并使用环境变量

```typescript
import { ConfigEnv, defineConfig, loadEnv, UserConfig } from 'vite';
import vue from '@vitejs/plugin-vue';
import path from 'node:path';

// https://vitejs.dev/config/
export default ({ mode }: ConfigEnv): UserConfig => {
  const envConfig = loadEnv(mode, process.cwd());
  return defineConfig({
    plugins: [vue()],
    resolve: {
      alias: {
        '@': path.resolve(__dirname, 'src'),
      },
    },
    base: envConfig.VITE_BASE_URL,
    server: {
      port: Number(envConfig.VITE_APP_PORT),
      proxy: {
        [envConfig.VITE_BASE_API_PATH]: {
          target: envConfig.VITE_BASE_API_ORIGIN,
          changeOrigin: true,
        },
      },
    },
  });
};
```

## 7. 配置请求

1. 安装依赖

```bash
pnpm add axios
```

2. 新建`src/utils/axios.ts`

```typescript
import axios from 'axios';

const instance = axios.create({
  baseURL: import.meta.env.VITE_BASE_API_ORIGIN + import.meta.env.VITE_BASE_API_PATH,
  headers: {
    'Content-Type': 'application/json',
  },
});

instance.interceptors.request.use(
  (config) => {
    // Add authorization token if available
    const token = localStorage.getItem('access_token');
    if (token) {
      config.headers['Authorization'] = `Bearer ${token}`;
    }
    return config;
  },
  (error) => {
    Promise.reject(error);
  },
);

instance.interceptors.response.use(
  (response) => {
    if (response.status >= 200 && response.status < 300) {
      response.data.suceess = true;
      return response.data;
    } else {
      return response.data;
    }
  },
  (error) => {
    if (error.response) {
      if (error.response.data) {
        error.response.data.suceess = false;
      }
      return error.response?.data || error;
    }
  },
);
```

3. 新建`src/services/user/index.ts`、`src/services/user/interface.ts`、`src/types/custom-types.d.ts`

```typescript
// src/types/custom-types.d.ts
export interface IBasicResponse<T> {
  error_code: string;
  message: string;
  data: T;
  success: boolean;
}

export interface IPaging {
  page_no: number;
  page_size: number;
  total: number;
}
export interface IPagingResponse<T> extends IBasicResponse<T> {
  data: {
    paging: IPaging;
    data: T[];
  };
}
```

```typescript
// src/services/user/index.ts
import axios from '@/utils/axios';
import { ILoginParams, ILoginResponse } from './interface';
import { IBasicResponse } from '@/types/custom-types';

export function login(params: ILoginParams) {
  return axios<ILoginResponse, IBasicResponse<ILoginResponse>, ILoginParams>('/login', {
    method: 'POST',
    data: params,
  });
}
```

```typescript
// src/services/user/interface.ts
export interface ILoginParams {
  username: string;
  password: string;
  captcha: string;
}

export interface ILoginResponse {
  access_token: string;
  refresh_token: string;
}
```

## 8. 配置`prettier`，`eslint`

1. 安装依赖

```bash
pnpm add add eslint -D
pnpm add prettier -D
pnpm add eslint-plugin-vue -D # eslint react 规则
pnpm add @typescript-eslint/parser -D
pnpm add @typescript-eslint/eslint-plugin -D
pnpm add eslint-plugin-prettier -D # eslint prettier
pnpm add eslint-config-prettier -D # 解决eslint与prettier冲突
```

2. 创建 `.prettierrc`

```json
{
  "endOfLine": "auto",
  "printWidth": 120,
  "semi": true,
  "singleQuote": true,
  "tabWidth": 2,
  "trailingComma": "all",
  "bracketSpacing": true
}
```

3. 修改`.eslintrc.cjs`

```javascript
module.exports = {
  env: {
    browser: true,
    node: true,
    es2021: true,
  },
  parser: 'vue-eslint-parser',
  extends: [
    'eslint:recommended',
    'plugin:vue/vue3-recommended',
    'plugin:@typescript-eslint/recommended',
    'plugin:prettier/recommended',
    'eslint-config-prettier',
  ],
  parserOptions: {
    ecmaVersion: 'latest',
    parser: '@typescript-eslint/parser',
    sourceType: 'module',
    ecmaFeatures: {
      jsx: true,
    },
  },
  plugins: ['vue', '@typescript-eslint', 'prettier'],
  rules: {
    'vue/multi-word-component-names': 'off', // 禁用vue文件强制多个单词命名
    '@typescript-eslint/no-explicit-any': ['off'], //允许使用any
    '@typescript-eslint/no-this-alias': [
      'error',
      {
        allowedNames: ['that'], // this可用的局部变量名称
      },
    ],
    '@typescript-eslint/ban-ts-comment': 'off', //允许使用@ts-ignore
    '@typescript-eslint/no-non-null-assertion': 'off', //允许使用非空断言
    'no-console': [
      //提交时不允许有console.log
      'warn',
      {
        allow: ['warn', 'error'],
      },
    ],
    'no-debugger': 'warn', //提交时不允许有debugger
  },
};
```

4. 新建`.prettierignore`

```bash
# 忽略格式化文件 (根据项目需要自行添加)
node_modules
dist
```

5. vscode 保存自动格式化

```json
  "editor.codeActionsOnSave": {
    "source.fixAll": "always"
  }
```

## 9. 配置`husky`、`lint-staged`、`@commitlint/cli`

`husky`：一个为`git`客户端增加`hook`的工具
`lint-staged`：仅对`git`代码暂存区文件进行处理，配合`husky`使用
`@commitlint/cli`：让`commit`信息规范化

1. 安装依赖

```bash
pnpm add husky -D
pnpm add lint-staged -D
pnpm add @commitlint/cli -D
pnpm add @commitlint/config-conventional -D
```

2. 配置`husky`

```bash
# 生成 .husky 的文件夹
pnpm exec husky init

# 添加 hooks，会在 .husky 目录下生成一个 pre-commit 脚本文件
echo "npx --no-install lint-staged" > .husky/pre-commit

# 添加 commit-msg
echo  'npx --no-install commitlint --edit "$1"' > .husky/commit-msg
```

3. 修改`package.json`

```json
  "lint-staged": {
    "src/**/*.{vue,js,jsx,ts,tsx,json}": [
      "pnpm run lint",
      "prettier --write"
    ]
  },
```

4. 新建`commitlint.config.cjs`

```javascript
module.exports = {
  extends: ['@commitlint/config-conventional'],
};
```

提交格式：

```bash
git commit -m <type>[optional scope]: <description> # 注意冒号后面有空格
- type：提交的类型（如新增、修改、更新等）
- optional scope：涉及的模块，可选
- description：任务描述

```

type 类型：

| 类别     | 含义                                     |
| -------- | ---------------------------------------- |
| feat     | 新功能                                   |
| fix      | 修复 bug                                 |
| style    | 样式修改（UI 校验）                      |
| docs     | 文档更新                                 |
| refactor | 重构代码(既没有新增功能，也没有修复 bug) |
| perf     | 优化相关，比如提升性能、体验             |
| test     | 增加测试，包括单元测试、集成测试等       |
| build    | 构建系统或外部依赖项的更改               |
| ci       | 自动化流程配置或脚本修改                 |
| revert   | 回退某个 commit 提交                     |

5. 示范（非规范提交，将提交失败）

```bash
git commit -m 'feat: 增加登录功能' # 提交成功
git commit -m 'bug: 修复登录失败功能' # 将会提交失败
```

## 10. 配置`unocss`、添加`vueuse`

`unocss` 原子化 `vueuse` 一个好用的 `vue` `hooks` 库

1. 安装依赖

```bash
pnpm add unocss @unocss/reset -D
pnpm add @vueuse/core
```

2. 在 vite.config.ts 里面引入

```typescript
import UnoCSS from 'unocss/vite';
import { defineConfig } from 'vite';

export default defineConfig({
  plugins: [UnoCSS()],
});
```

3. 创建`src/uno.config.ts`

```ts
import {
  defineConfig,
  presetUno,
  presetIcons,
  presetAttributify,
  presetTypography,
  presetWebFonts,
  transformerDirectives,
  transformerVariantGroup,
} from 'unocss';

export default defineConfig({
  presets: [
    // 默认预设
    presetUno(),
    // 支持attributify mode,简单说就是为了避免样式写太长难维护，能将py-2 px-2这种相关属性整合起来写成p="y-2 x-4"
    presetAttributify(),
    presetIcons(),
    presetTypography(),
    presetWebFonts(),
  ],
  transformers: [transformerDirectives(), transformerVariantGroup()],
});
```

4. 在`src/main.ts` 引入 `unocss`

```tsx
import { createApp } from 'vue';
import './style.css';
import Antd from 'ant-design-vue';
import App from './App.vue';
import router from './router/index';
import store from './store';
import 'ant-design-vue/dist/reset.css';
import 'virtual:uno.css';
import 'virtual:svg-icons-register';

const app = createApp(App);

app.use(router).use(store).use(Antd).mount('#app');
```

5. 在`src/pages/home/index.vue`使用`unocss`和`vueuse`

```vue
<script lang="ts" setup>
import { storeToRefs } from 'pinia';
import { useCounterStore } from '@/store/counter';
import { useIntervalFn } from '@vueuse/core';
import { onMounted, ref } from 'vue';
const counterStore = useCounterStore();
// storeToRefs 会跳过所有的 action 属性
const { count } = storeToRefs(counterStore);
const { increase, decrease } = counterStore;
const time = ref(0);
const { pause, resume } = useIntervalFn(
  () => {
    time.value--;
    if (time.value <= 0) {
      pause();
    }
  },
  1000,
  { immediate: false },
);
onMounted(() => {
  pause();
});
const start = () => {
  time.value = 60;
  resume();
};
</script>
<template>
  <div class="text-blue">home page</div>
  <div>count: {{ count }}</div>
  <button @click="increase">+1</button>
  <button @click="decrease">-1</button>
  <a-button type="primary">主要按钮</a-button>
  <a-button>Default Button</a-button>
  <a-button type="dashed">Dashed Button</a-button>
  <a-button type="text">Text Button</a-button>
  <a-button type="link">Link Button</a-button>
  <a-button type="primary" @click="start">{{ time <= 0 ? '开始倒计时60s' : `还剩${time}s` }}</a-button>
</template>
<style lang="scss">
body {
  color: $test-color;
}
</style>
```

## 11. 配置svgIcon

1. 安装依赖

```bash
pnpm add vite-plugin-svg-icons -D
```

2. 在vite.config.ts中引用

```ts
import { defineConfig } from 'vite';
import { createSvgIconsPlugin } from 'vite-plugin-svg-icons';
defineConfig({
  plugins: [
    createSvgIconsPlugin({
      // 指定需要缓存的图标文件夹
      iconDirs: [path.resolve(process.cwd(), 'src/assets/icons')],
      // 指定symbolId格式
      symbolId: 'icon-[dir]-[name]',
    }),
  ],
});
```

3. 创建`src/components/SvgIcon/index.vue`

```vue
<script setup lang="ts">
import { computed } from 'vue';
const props = defineProps({
  prefix: {
    type: String,
    default: 'icon',
  },
  name: {
    type: String,
    required: false,
  },
  color: {
    type: String,
  },
  size: {
    type: String,
    default: '1em',
  },
});

const symbolId = computed(() => `#${props.prefix}-${props.name}`);
</script>

<template>
  <svg aria-hidden="true" class="svg-icon" :style="'width:' + size + ';height:' + size">
    <use :xlink:href="symbolId" :fill="color" />
  </svg>
</template>

<style scoped>
.svg-icon {
  display: inline-block;
  outline: none;
  width: 1em;
  height: 1em;
  vertical-align: -0.15em; /* 因icon大小被设置为和字体大小一致，而span等标签的下边缘会和字体的基线对齐，故需设置一个往下的偏移比例，来纠正视觉上的未对齐效果 */
  fill: currentColor; /* 定义元素的颜色，currentColor是一个变量，这个变量的值就表示当前元素的color值，如果当前元素未设置color值，则从父元素继承 */
  overflow: hidden;
}
</style>
```

4. 在`src/pages/home/index.vue`中使用

```vue
<script lang="ts" setup>
import { storeToRefs } from 'pinia';
import { useCounterStore } from '@/store/counter';
import { useIntervalFn } from '@vueuse/core';
import { onMounted, ref } from 'vue';
import SvgIcon from '@/components/SvgIcon/index.vue';
const counterStore = useCounterStore();
// storeToRefs 会跳过所有的 action 属性
const { count } = storeToRefs(counterStore);
const { increase, decrease } = counterStore;
const time = ref(0);
const { pause, resume } = useIntervalFn(
  () => {
    time.value--;
    if (time.value <= 0) {
      pause();
    }
  },
  1000,
  { immediate: false },
);
onMounted(() => {
  pause();
});
const start = () => {
  time.value = 60;
  resume();
};
</script>
<template>
  <div class="text-blue">home page</div>
  <div>count: {{ count }}</div>
  <button @click="increase">+1</button>
  <button @click="decrease">-1</button>
  <a-button type="primary">主要按钮</a-button>
  <a-button>Default Button</a-button>
  <a-button type="dashed">Dashed Button</a-button>
  <a-button type="text">Text Button</a-button>
  <a-button type="link">Link Button</a-button>
  <a-button type="primary" @click="start">{{ time <= 0 ? '开始倒计时60s' : `还剩${time}s` }}</a-button>
  <svg-icon name="vue" width="15px" height="15px" color="#fff" />
</template>
<style lang="scss">
body {
  color: $test-color;
}
</style>
```

## 12. 配置 scss

`Ant Design Vue`已经采用`css-in-js`方案，不再需要安装 less。我们这里安装`scss`

1. 安装依赖

```bash
pnpm add sass -D
```

2. 配置全局`scss`样式

- 新建`src/styles/index.scss`

```scss
$test-color: red;
```

- 配置`vite.config.ts`

```typescript
css: {
    preprocessorOptions: {
      scss: {
        additionalData: '@import "@/styles/index.scss";',
      },
    },
  },

```

- 在组件中引入，修改`src/pages/home/index.vue`

```vue
<script lang="ts" setup>
import { storeToRefs } from 'pinia';
import { useCounterStore } from '@/store/counter';
import { useIntervalFn } from '@vueuse/core';
import { onMounted, ref } from 'vue';
const counterStore = useCounterStore();
// storeToRefs 会跳过所有的 action 属性
const { count } = storeToRefs(counterStore);
const { increase, decrease } = counterStore;
const time = ref(0);
const { pause, resume } = useIntervalFn(
  () => {
    time.value--;
    if (time.value <= 0) {
      pause();
    }
  },
  1000,
  { immediate: false },
);
onMounted(() => {
  pause();
});
const start = () => {
  time.value = 60;
  resume();
};
</script>
<template>
  <div class="text-blue">home page</div>
  <div>count: {{ count }}</div>
  <button @click="increase">+1</button>
  <button @click="decrease">-1</button>
  <a-button type="primary">主要按钮</a-button>
  <a-button>Default Button</a-button>
  <a-button type="dashed">Dashed Button</a-button>
  <a-button type="text">Text Button</a-button>
  <a-button type="link">Link Button</a-button>
  <a-button type="primary" @click="start">{{ time <= 0 ? '开始倒计时60s' : `还剩${time}s` }}</a-button>
</template>
<style lang="scss">
body {
  color: $test-color;
}
</style>
```

## 13. 打包配置

1. 分包，修改`vite.config.ts`

```typescript
  build: {
    rollupOptions: {
      output: {
        manualChunks: {
          react: ['react', 'react-dom', 'react-router-dom', 'zustand'],
          antd: ['antd'],
        },
      },
    },
  },

```

2. 生成`.gz`文件

- 安装依赖

```bash
pnpm add vite-plugin-compression -D

```

- 修改`vite.config.ts`
  默认情况下插件在开发 (`serve`) 和生产 (`build`) 模式中都会调用，使用 `apply` 属性指明它们仅在 `build` 或 `serve` 模式时调用

```typescript
import viteCompression from 'vite-plugin-compression'

  plugins: [
    //...
    {
      ...viteCompression(),
      apply: 'build',
    },
  ],

```

3. `js`和`css`文件分离

```typescript
 build: {
  rollupOptions: {
    output: {
      chunkFileNames: "static/js/[name]-[hash].js",
      entryFileNames: "static/js/[name]-[hash].js",
      assetFileNames: "static/[ext]/[name]-[hash].[ext]",
    },
  },
},
```

4. 分析生成包的大小

- 安装依赖

```bash
pnpm add rollup-plugin-visualizer -D
```

- 修改`vite.config.ts`

```typescript
import { visualizer } from 'rollup-plugin-visualizer';

  plugins: [
    //...
    visualizer({ open: true }),
  ],
```
